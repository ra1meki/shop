<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>MEGASHOP.COM</title>
    <style>
    td, th {padding:5px;min-width:90px;max-width:200px; text-align:start;}
    .btn {padding:4px; border:1px solid #333; background-color: #eee; border-radius: 2px; margin:5px; cursor:pointer;}
    </style>
</head>
<body>
<h2>Каталог</h2>
<form name="productForm">
    <input type="hidden" name="id" value="0" />
    <p>
        <label>Продукт:</label><br>
        <input name="name" />
    </p>
    <p>
        <label>Цена:</label><br>
        <input name="cost" type="number" />
    </p>
    <p>
        <button id="submitBtn" type="submit">Добавить</button>
        <button id="resetBtn">Сбросить</button>
    </p>
</form>
<table>
    <thead><tr><th>Id</th><th>Продукт</th><th>Цена</th><th></th></tr></thead>
    <tbody></tbody>
</table>
<script>
const tbody = document.querySelector("tbody");
async function GetProducts() {
    const response = await fetch("/api/products", {
        method: "GET",
        headers: { "Accept": "application/json" }
    });
    if (response.ok === true) {
    const products = await response.json(); 
        products.forEach(product => {
            tbody.append(row(product));
        });
    }
}
async function GetProduct(id) {
    const response = await fetch("/api/products/" + id, {
        method: "GET",
        headers: { "Accept": "application/json" }
    });
    if (response.ok === true) {
        const product = await response.json();
        const form = document.forms["productForm"];
        form.elements["id"].value = product.id;
        form.elements["name"].value = product.name;
        form.elements["cost"].value = product.cost;
    }
}
async function CreateProduct(product, productCost) {
    const response = await fetch("api/products", {
        method: "POST",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify({
            name: product,
            cost: parseInt(productCost, 10)
        })
    });
    if (response.ok === true) {
        const product = await response.json();
        reset();
        tbody.append(row(product));
    }
}
async function EditProduct(productId, productName, productCost) {
    const response = await fetch("api/products", {
        method: "PUT",
        headers: { "Accept": "application/json", "Content-Type": "application/json" },
        body: JSON.stringify({
            id: productId,
            name: productName,
            cost: parseInt(productCost, 10)
        })
    });
    if (response.ok === true) {
        const product = await response.json();
        reset();
        document.querySelector(`tr[data-rowid="${product.id}"]`).replaceWith(row(product));
    }
}
async function DeleteProduct(id) {
    const response = await fetch("/api/products/" + id, {
        method: "DELETE",
        headers: { "Accept": "application/json" }
    });
    if (response.ok === true) {
        const product = await response.json();
        document.querySelector(`tr[data-rowid="${product.id}"]`).remove();
    }
}
    
function reset() {
    const form = document.forms["productForm"];
    console.log(form);
    form.reset();
    form.elements["id"].value = 0;
}
function row(product) {
    
    const tr = document.createElement("tr");
    tr.setAttribute("data-rowid", product.id);
        
    const idTd = document.createElement("td");
    idTd.append(product.id);
    tr.append(idTd);
        
    const nameTd = document.createElement("td");
    nameTd.append(product.name);
    tr.append(nameTd);
        
    const costTd = document.createElement("td");
    costTd.append(product.cost);
    tr.append(costTd);
        
    const linksTd = document.createElement("td");
        
    const removeLink = document.createElement("a");
    removeLink.setAttribute("data-id", product.id);
    removeLink.setAttribute("class", "btn");
    removeLink.append("Удалить");
    removeLink.addEventListener("click", e => {
        e.preventDefault();
        DeleteProduct(product.id);
    });
        
    linksTd.append(removeLink);
    tr.appendChild(linksTd);
        
    return tr;
}
document.getElementById("resetBtn").addEventListener("click", e => {
    e.preventDefault();
    reset();
});
    
document.forms["productForm"].addEventListener("submit", e => {
    e.preventDefault();
    const form = document.forms["productForm"];
    const id = form.elements["id"].value;
    const name = form.elements["name"].value;
    const cost = form.elements["cost"].value;
    if (id == 0)
        CreateProduct(name, cost);
    else
        EditProduct(id, name, cost);
});

    
GetProducts();
</script>
</body>
</html>